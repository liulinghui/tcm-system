from flask import Flask, render_template, request, jsonify
from datetime import datetime, timedelta

class LunarDate:
    def __init__(self):
        self.lunar_info = [
            0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
            0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
            0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
            0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
            0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557
        ]

    def solar_to_lunar(self, date):
        def get_leap_month(year):
            return self.lunar_info[year - 1900] & 0xf

        def get_leap_days(year):
            if get_leap_month(year):
                return (self.lunar_info[year - 1900] & 0x10000) and 30 or 29
            return 0

        def get_lunar_days(year, month):
            return (self.lunar_info[year - 1900] & (0x10000 >> month)) and 30 or 29

        date = datetime.strptime(date_str, '%Y-%m-%d')
        lunar = LunarDate()
        year, month, day, is_leap = lunar.solar_to_lunar(date)
        
        year_gan = (year - 4) % 10
        year_zhi = (year - 4) % 12
        
        # 月干支计算，需考虑节气
        month_gan = (year_gan * 2 + month + 1) % 10
        month_zhi = (month + 2) % 12  # 寅月为正月
        
        # 日干支计算
        base_date = datetime(1900, 1, 31)  # 1900年1月31日为 己卯日
        days = (date - base_date).days
        day_gan = (days + 6) % 10  # 从己开始
        day_zhi = (days + 6) % 12  # 从卯开始
        
        return {
            'lunar_year': year,
            'lunar_month': month,
            'lunar_day': day,
            'is_leap': is_leap,
            'year_ganzhi': f"{HEAVENLY_STEMS[year_gan]}{EARTHLY_BRANCHES[year_zhi]}",
            'month_ganzhi': f"{HEAVENLY_STEMS[month_gan]}{EARTHLY_BRANCHES[month_zhi]}",
            'day_ganzhi': f"{HEAVENLY_STEMS[day_gan]}{EARTHLY_BRANCHES[day_zhi]}"
        }

app = Flask(__name__)

# 天干
HEAVENLY_STEMS = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸']
# 地支
EARTHLY_BRANCHES = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥']

# 男性主病对应表
MALE_DISEASE_MAP = {
    '子': {  # 鼠
        '甲': '小肠火', '乙': '脾土', '丙': '大肠金', '丁': '肾水', '戊': '胆木',
        '己': '心火', '庚': '胃土', '辛': '肺金', '壬': '膀胱水', '癸': '肝木'
    },
    '丑': {  # 牛
        '甲': '心火', '乙': '胃土', '丙': '肺金', '丁': '膀胱水', '戊': '肝木',
        '己': '小肠火', '庚': '脾土', '辛': '大肠金', '壬': '肾水', '癸': '胆木'
    },
    '寅': {  # 虎
        '甲': '小肠火', '乙': '脾土', '丙': '大肠金', '丁': '肾水', '戊': '胆木',
        '己': '心火', '庚': '胃土', '辛': '肺金', '壬': '膀胱水', '癸': '肝木'
    },
    '卯': {  # 兔
        '甲': '心火', '乙': '大肠金', '丙': '肺金', '丁': '胆木', '戊': '肝木',
        '己': '胃土', '庚': '脾土', '辛': '膀胱水', '壬': '肾水', '癸': '小肠火'
    },
    '辰': {  # 龙
        '甲': '胃土', '乙': '心火', '丙': '膀胱水', '丁': '肺金', '戊': '小肠火',
        '己': '肝木', '庚': '大肠金', '辛': '脾土', '壬': '胆木', '癸': '肾水'
    },
    '巳': {  # 蛇
        '甲': '肝木', '乙': '膀胱水', '丙': '脾土', '丁': '小肠火', '戊': '肾水',
        '己': '大肠金', '庚': '心火', '辛': '胆木', '壬': '肺金', '癸': '胃土'
    },
    '午': {  # 马
        '甲': '大肠金', '乙': '肝木', '丙': '胆木', '丁': '脾土', '戊': '胃土',
        '己': '肾水', '庚': '膀胱水', '辛': '心火', '壬': '小肠火', '癸': '肺金'
    },
    '未': {  # 羊
        '甲': '肾水', '乙': '胆木', '丙': '心火', '丁': '胃土', '戊': '肺金',
        '己': '膀胱水', '庚': '肝木', '辛': '小肠火', '壬': '脾土', '癸': '大肠金'
    },
    '申': {  # 猴
        '甲': '膀胱水', '乙': '肾水', '丙': '小肠火', '丁': '心火', '戊': '大肠金',
        '己': '肺金', '庚': '胆木', '辛': '肝木', '壬': '胃土', '癸': '脾土'
    },
    '酉': {  # 鸡
        '甲': '肺金', '乙': '小肠火', '丙': '肝木', '丁': '大肠金', '戊': '脾土',
        '己': '胆木', '庚': '肾水', '辛': '胃土', '壬': '心火', '癸': '膀胱水'
    },
    '戌': {  # 狗
        '甲': '胆木', '乙': '肺金', '丙': '胃土', '丁': '肝木', '戊': '膀胱水',
        '己': '脾土', '庚': '小肠火', '辛': '肾水', '壬': '大肠金', '癸': '心火'
    },
    '亥': {  # 猪
        '甲': '脾土', '乙': '胃土', '丙': '肾水', '丁': '膀胱水', '戊': '心火',
        '己': '小肠火', '庚': '肺金', '辛': '大肠金', '壬': '肝木', '癸': '胆木'
    }
}

# 女性主病对应表
FEMALE_DISEASE_MAP = {
    '子': {  # 鼠
        '甲': '胃土', '乙': '脾土', '丙': '膀胱水', '丁': '肾水', '戊': '小肠火',
        '己': '心火', '庚': '大肠金', '辛': '肺金', '壬': '胆木', '癸': '肝木'
    },
    '丑': {  # 牛
        '甲': '心火', '乙': '胃土', '丙': '肺金', '丁': '膀胱水', '戊': '肝木',
        '己': '小肠火', '庚': '脾土', '辛': '大肠金', '壬': '肾水', '癸': '胆木'
    },
    '寅': {  # 虎
        '甲': '小肠火', '乙': '脾土', '丙': '大肠金', '丁': '肾水', '戊': '胆木',
        '己': '心火', '庚': '胃土', '辛': '肺金', '壬': '膀胱水', '癸': '肝木'
    },
    '卯': {  # 兔
        '甲': '心火', '乙': '胃土', '丙': '肺金', '丁': '膀胱水', '戊': '肝木',
        '己': '小肠火', '庚': '脾土', '辛': '大肠金', '壬': '肾水', '癸': '胆木'
    },
    '辰': {  # 龙
        '甲': '小肠火', '乙': '肺金', '丙': '大肠金', '丁': '肝木', '戊': '胆木',
        '己': '脾土', '庚': '胃土', '辛': '肾水', '壬': '膀胱水', '癸': '心火'
    },
    '巳': {  # 蛇
        '甲': '脾土', '乙': '小肠火', '丙': '肾水', '丁': '大肠金', '戊': '心火',
        '己': '胆木', '庚': '肺金', '辛': '胃土', '壬': '肝木', '癸': '膀胱水'
    },
    '午': {  # 马
        '甲': '胆木', '乙': '肾水', '丙': '胃土', '丁': '心火', '戊': '膀胱水',
        '己': '肺金', '庚': '小肠火', '辛': '肝木', '壬': '大肠金', '癸': '脾土'
    },
    '未': {  # 羊
        '甲': '肺金', '乙': '胆木', '丙': '肝木', '丁': '胃土', '戊': '脾土',
        '己': '膀胱水', '庚': '肾水', '辛': '小肠火', '壬': '心火', '癸': '大肠金'
    },
    '申': {  # 猴
        '甲': '膀胱水', '乙': '肝木', '丙': '小肠火', '丁': '脾土', '戊': '大肠金',
        '己': '肾水', '庚': '胆木', '辛': '心火', '壬': '胃土', '癸': '肺金'
    },
    '酉': {  # 鸡
        '甲': '肾水', '乙': '膀胱水', '丙': '心火', '丁': '小肠火', '戊': '肺金',
        '己': '大肠金', '庚': '肝木', '辛': '胆木', '壬': '脾土', '癸': '胃土'
    },
    '戌': {  # 狗
        '甲': '大肠金', '乙': '心火', '丙': '胆木', '丁': '肺金', '戊': '胃土',
        '己': '肝木', '庚': '膀胱水', '辛': '脾土', '壬': '小肠火', '癸': '肾水'
    },
    '亥': {  # 猪
        '甲': '肝木', '乙': '大肠金', '丙': '脾土', '丁': '胆木', '戊': '肾水',
        '己': '胃土', '庚': '心火', '辛': '膀胱水', '壬': '肺金', '癸': '小肠火'
    }
}

# 行流对应表（出生年地支 + 发病日天干）
FLOW_MAP = {
    '子': {  # 鼠
        '甲': '癸水', '己': '癸水',  # 甲己同列
        '乙': '乙木', '庚': '乙木',  # 乙庚同列
        '丙': '丁火', '辛': '丁火',  # 丙辛同列
        '丁': '己土', '壬': '己土',  # 丁壬同列
        '戊': '辛金', '癸': '辛金'   # 戊癸同列
    },
    '丑': {  # 牛
        '甲': '乙木', '己': '乙木',
        '乙': '丁火', '庚': '丁火',
        '丙': '己土', '辛': '己土',
        '丁': '辛金', '壬': '辛金',
        '戊': '癸水', '癸': '癸水'
    },
    '寅': {  # 虎
        '甲': '丙火', '己': '丙火',
        '乙': '戊土', '庚': '戊土',
        '丙': '庚金', '辛': '庚金',
        '丁': '壬水', '壬': '壬水',
        '戊': '甲木', '癸': '甲木'
    },
    '卯': {  # 兔
        '甲': '丙火', '己': '丙火',
        '乙': '戊土', '庚': '戊土',
        '丙': '庚金', '辛': '庚金',
        '丁': '壬水', '壬': '壬水',
        '戊': '甲木', '癸': '甲木'
    },
    '辰': {  # 龙
        '甲': '丙火', '己': '丙火',
        '乙': '戊土', '庚': '戊土',
        '丙': '庚金', '辛': '庚金',
        '丁': '壬水', '壬': '壬水',
        '戊': '甲木', '癸': '甲木'
    },
    '巳': {  # 蛇
        '甲': '丁火', '己': '丁火',
        '乙': '己土', '庚': '己土',
        '丙': '辛金', '辛': '辛金',
        '丁': '癸水', '壬': '癸水',
        '戊': '乙木', '癸': '乙木'
    },
    '午': {  # 马
        '甲': '丁火', '己': '丁火',
        '乙': '己土', '庚': '己土',
        '丙': '辛金', '辛': '辛金',
        '丁': '癸水', '壬': '癸水',
        '戊': '乙木', '癸': '乙木'
    },
    '未': {  # 羊
        '甲': '己土', '己': '己土',
        '乙': '辛金', '庚': '辛金',
        '丙': '癸水', '辛': '癸水',
        '丁': '乙木', '壬': '乙木',
        '戊': '丁火', '癸': '丁火'
    },
    '申': {  # 猴
        '甲': '庚金', '己': '庚金',
        '乙': '壬水', '庚': '壬水',
        '丙': '甲木', '辛': '甲木',
        '丁': '丙火', '壬': '丙火',
        '戊': '戊土', '癸': '戊土'
    },
    '酉': {  # 鸡
        '甲': '庚金', '己': '庚金',
        '乙': '壬水', '庚': '壬水',
        '丙': '甲木', '辛': '甲木',
        '丁': '丙火', '壬': '丙火',
        '戊': '戊土', '癸': '戊土'
    },
    '戌': {  # 狗
        '甲': '壬水', '己': '壬水',
        '乙': '甲木', '庚': '甲木',
        '丙': '丙火', '辛': '丙火',
        '丁': '戊土', '壬': '戊土',
        '戊': '庚金', '癸': '庚金'
    },
    '亥': {  # 猪
        '甲': '癸水', '己': '癸水',
        '乙': '乙木', '庚': '乙木',
        '丙': '丁火', '辛': '丁火',
        '丁': '己土', '壬': '己土',
        '戊': '辛金', '癸': '辛金'
    }
}

# 治疗方案映射配置
TREATMENT_MAP = {
    '风邪': {
        '肝木': {'加临': '风邪袭肝', '用方': '小柴胡汤'},
        '心火': {'加临': '风邪袭心', '用方': '黄连黄芩麦冬桔梗甘草汤'},
        '脾土': {'加临': '风邪乘脾', '用方': '桂枝去桂加茯苓白术汤'},
        '肺金': {'加临': '风邪乘肺', '用方': '桔梗甘草枳实芍药汤'},
        '肾水': {'加临': '风邪乘肾', '用方': '柴胡桂枝汤'},
        '小肠火': {'加临': '风邪乘小肠', '用方': '黄连黄芩麦冬桔梗甘草汤'},
        '胃土': {'加临': '风邪乘胃', '用方': '枳实厚朴白术甘草汤'},
        '大肠金': {'加临': '风邪袭大肠', '用方': '桔梗甘草枳实芍药加地黄牡丹汤'},
        '膀胱水': {'加临': '风邪乘膀胱', '用方': '柴胡桂枝汤'},
        '胆木': {'加临': '风邪乘胆', '用方': '柴胡芍药枳实甘草汤'}
    },
    '热邪': {
        '肝木': {'加临': '热邪袭肝', '用方': '黄连黄芩半夏猪胆汁汤'},
        '心火': {'加临': '热邪袭心', '用方': '黄连黄芩泻心汤'},
        '脾土': {'加临': '热邪乘脾', '用方': '大黄厚朴甘草汤'},
        '肺金': {'加临': '热邪乘肺', '用方': '黄连石膏半夏甘草汤'},
        '肾水': {'加临': '热邪移肾', '用方': '地黄黄柏黄连半夏汤'},
        '小肠火': {'加临': '热邪袭小肠', '用方': '黄连黄芩泻心汤'},
        '胃土': {'加临': '热邪乘胃', '用方': '大黄厚朴甘草汤'},
        '大肠金': {'加临': '热邪乘大肠', '用方': '黄连石膏半夏甘草汤'},
        '膀胱水': {'加临': '热邪移膀胱', '用方': '地黄黄柏黄连半夏汤'},
        '胆木': {'加临': '热邪袭胆', '用方': '黄连黄芩半夏猪胆汁'}
    },
    '湿邪': {
        '肝木': {'加临': '湿邪犯肝', '用方': '待补充'},
        '心火': {'加临': '湿邪犯心', '用方': '待补充'},
        '脾土': {'加临': '湿邪干脾', '用方': '理中汤'},
        '肺金': {'加临': '湿邪干肺', '用方': '小青龙汤'},
        '肾水': {'加临': '湿邪移肾', '用方': '五苓散'},
        '小肠火': {'加临': '湿邪犯小肠', '用方': '待补充'},
        '胃土': {'加临': '湿邪干胃', '用方': '白术茯苓厚朴汤'},
        '大肠金': {'加临': '湿邪干大肠', '用方': '小青龙汤'},
        '膀胱水': {'加临': '湿邪移膀胱', '用方': '五苓散'},
        '胆木': {'加临': '湿邪犯胆', '用方': '待补充'}
    },
    '燥邪': {
        '肝木': {'加临': '燥邪乘肝', '用方': '黄芩牡丹皮瓜蒌半夏枳实汤'},
        '心火': {'加临': '燥邪乘心', '用方': '栀子连翘甘草瓜蒌汤'},
        '脾土': {'加临': '燥邪乘脾', '用方': '白虎汤'},
        '肺金': {'加临': '燥邪乘肺', '用方': '竹叶石膏杏子甘草汤'},
        '肾水': {'加临': '燥邪干肾', '用方': '地黄黄柏茯苓瓜蒌汤'},
        '小肠火': {'加临': '燥邪乘小肠', '用方': '栀子连翘甘草瓜蒌汤'},
        '胃土': {'加临': '燥邪乘胃', '用方': '白虎汤'},
        '大肠金': {'加临': '燥邪乘大肠', '用方': '麻仁白蜜煎'},
        '膀胱水': {'加临': '燥邪干膀胱', '用方': '地黄黄柏茯苓瓜蒌汤'},
        '胆木': {'加临': '燥邪乘胆', '用方': '黄芩牡丹皮瓜蒌半夏枳实汤'}
    },
    '寒邪': {
        '肝木': {'加临': '寒邪乘肝', '用方': '小柴胡汤'},
        '心火': {'加临': '寒邪乘心', '用方': '通脉四逆汤'},
        '脾土': {'加临': '寒邪乘脾', '用方': '理中汤'},
        '肺金': {'加临': '寒邪乘肺', '用方': '甘草干姜汤'},
        '肾水': {'加临': '寒邪干肾', '用方': '桂枝加葛根汤'},
        '小肠火': {'加临': '寒邪乘小肠', '用方': '甘草泻心汤'},
        '胃土': {'加临': '寒邪乘胃', '用方': '枳实白术茯苓甘草汤'},
        '大肠金': {'加临': '寒邪乘大肠', '用方': '枳实橘皮桔梗半夏生姜甘草汤'},
        '膀胱水': {'加临': '寒邪干膀胱', '用方': '甘草干姜茯苓白术汤'},
        '胆木': {'加临': '寒邪乘胆', '用方': '柴胡黄芩芍药半夏甘草汤'}
    },
    '暑邪': {
        '肝木': {'加临': '暑邪袭肝', '用方': '黄连黄芩半夏猪胆汁汤'},
        '心火': {'加临': '暑邪袭心', '用方': '黄连半夏石膏甘草汤'},
        '脾土': {'加临': '暑邪乘脾', '用方': '待补充'},
        '肺金': {'加临': '暑邪乘肺', '用方': '竹叶石膏汤'},
        '肾水': {'加临': '暑邪移肾', '用方': '待补充'},
        '小肠火': {'加临': '暑邪袭小肠', '用方': '黄连半夏石膏甘草汤'},
        '胃土': {'加临': '暑邪乘胃', '用方': '待补充'},
        '大肠金': {'加临': '暑邪乘大肠', '用方': '百合地黄加牡蛎汤'},
        '膀胱水': {'加临': '暑邪移膀胱', '用方': '待补充'},
        '胆木': {'加临': '寒邪乘胆', '用方': '柴胡黄芩芍药半夏甘草汤'}
    }
}

def get_treatment_info(evil_qi, disease):
    """获取治疗方案信息"""
    if evil_qi in TREATMENT_MAP and disease in TREATMENT_MAP[evil_qi]:
        return TREATMENT_MAP[evil_qi][disease]
    return {'加临': '未知', '用方': '未知'}

def get_prescription_details(prescription_name):
    """获取处方的详细信息"""
    return PRESCRIPTION_DETAILS.get(prescription_name, {
        '处方组成': [],
        '功效主治': '未知',
        '条文': {'出处': '未知', '原文': '未知', '注释': '未知'},
        '禁忌': '未知',
    })

# 处方详细信息映射表
PRESCRIPTION_DETAILS = {
    '小柴胡汤': {   
        '处方组成': [
            {'药名': '柴胡', '用量': '8钱',},
            {'药名': '黄芩', '用量': '3钱',},
            {'药名': '人参', '用量': '3钱', },
            {'药名': '炙甘草', '用量': '3钱', },
            {'药名': '半夏', '用量': '4钱', },
            {'药名': '生姜', '用量': '3钱', },
            {'药名': '大枣', '用量': '3枚',}
        ],
        '功效主治': '和解少阳，调和肝胃，兼有补气健脾之效',
        '条文': {
            '出处': '伤寒杂病论',
            '原文': '柴胡半斤 黄芩三两 人参三两 半夏半升（洗）甘草三两（炙） 生姜三两（切） 大枣十二枚（擘）右七味，以水一斗二升，煮取六升，去滓，再煎取三升，温服一升，日三服。',
            '注释': '若胸中烦而不呕，去半夏、人参，加栝蒌实一枚。\n\
                    若渴，去半夏，加人参，合前成四两半，栝蒌根四两。\n\
                    若腹中痛者，去黄芩，加芍药三两。\n\
                    若胁下痞硬，去大枣，加牡蛎四两。\n\
                    若心下悸，小便不利者，去黄芩，加茯苓四两。\n\
                    若不渴，外有微热者，去人参，加桂枝三两，温覆微汗愈。\n\
                    若咳者，去人参、大枣、生姜，加五味子半升，干姜二两。'
        },
    },


      
  
    
    '黄连黄芩麦冬桔梗甘草汤': {
        '处方组成': [
            {'药名': '黄连', '用量': '待补充', '功效': '清心火'},
            {'药名': '黄芩', '用量': '待补充', '功效': '清上焦热'},
            {'药名': '麦冬', '用量': '待补充', '功效': '养阴润肺'},
            {'药名': '桔梗', '用量': '待补充', '功效': '宣肺'},
            {'药名': '甘草', '用量': '待补充', '功效': '调和诸药'}
        ],
        '功效主治': '待补充',
        '条文': {
            '出处': '待补充',
            '原文': '待补充',
            '注释': '待补充'
        },
        '禁忌': '待补充',
        '用法': '待补充'
    },
    
    '桂枝去桂加茯苓白术汤': {
        '处方组成': [
            {'药名': '白芍', '用量': '待补充', '功效': '待补充'},
            {'药名': '茯苓', '用量': '待补充', '功效': '待补充'},
            {'药名': '白术', '用量': '待补充', '功效': '待补充'},
            {'药名': '生姜', '用量': '待补充', '功效': '待补充'},
            {'药名': '大枣', '用量': '待补充', '功效': '待补充'},
            {'药名': '甘草', '用量': '待补充', '功效': '待补充'}
        ],
        '功效主治': '待补充',
        '条文': {
            '出处': '待补充',
            '原文': '待补充',
            '注释': '待补充'
        },
        '禁忌': '待补充',
        '用法': '待补充'
    }
    # ... 其他处方的详细信息
}

def calculate_base_ganzhi(year):
    """计算某年1月1日的日干支基数"""
    year_last_two = year % 100
    
    if 900 <= year <= 1999:
        base = (year_last_two + 3) * 5 + 55 + (year_last_two - 1) // 4
    elif 2000 <= year <= 2099:
        base = (year_last_two + 7) * 5 + 15 + (year_last_two + 19) // 4
    else:
        raise ValueError("年份必须在900-2099之间")
    
    return base % 60

def get_days_in_month(year, month):
    """获取某月的天数"""
    if month in [4, 6, 9, 11]:
        return 30
    elif month == 2:
        if year % 4 == 0 and (year % 100 != 0 or year % 400 == 0):
            return 29
        return 28
    else:
        return 31

def calculate_days_from_new_year(year, month, day):
    """计算从当年1月1日到指定日期的天数"""
    days = 0
    for m in range(1, month):
        days += get_days_in_month(year, m)
    days += day
    return days

def get_stem_branch(date):
    """获取某一天的天干"""
    year = date.year
    month = date.month
    day = date.day
    
    base = calculate_base_ganzhi(year)
    days = calculate_days_from_new_year(year, month, day)
    final_number = (base + days - 1) % 60
    stem_index = (final_number % 10)
    
    return HEAVENLY_STEMS[stem_index]

def get_year_branch(year):
    """获取年份对应的地支"""
    base_year = 1984  # 1984年是子年
    year_diff = (year - base_year) % 12
    if year_diff < 0:
        year_diff += 12
    return EARTHLY_BRANCHES[year_diff]

def get_month_ganzhi(year, month):
    """计算月份的天干地支"""
    # 月干 = (年干 × 2 + 月数) % 10
    year_gan = (year - 4) % 10
    month_gan = (year_gan * 2 + month) % 10
    # 寅月为正月
    month_zhi = (month + 2) % 12
    return f"{HEAVENLY_STEMS[month_gan]}{EARTHLY_BRANCHES[month_zhi]}"

def get_day_ganzhi(date):
    """计算日期的天干地支"""
    base_date = datetime(1900, 1, 31)  # 1900年1月31日为 癸卯日
    diff_days = (date - base_date).days
    gan = (diff_days + 40) % 10  # 40是癸的索引位置
    zhi = (diff_days + 40) % 12
    return f"{HEAVENLY_STEMS[gan]}{EARTHLY_BRANCHES[zhi]}"

def get_year_ganzhi(year):
    """计算年份的天干地支"""
    gan = (year - 4) % 10
    zhi = (year - 4) % 12
    return f"{HEAVENLY_STEMS[gan]}{EARTHLY_BRANCHES[zhi]}"

def get_info(birth_date_str, illness_date_str, gender):
    """获取主病和行流信息"""
    try:
        # 计算出生日期的农历和天干地支信息
        birth_info = get_lunar_date_info(birth_date_str)
        illness_info = get_lunar_date_info(illness_date_str)
        
        # ... 其他代码保持不变 ...

        return {
            'birth_info': birth_info,
            'illness_info': illness_info,
            'disease': disease,
            'flow': flow,
            'evil_qi': evil_qi,
            'treatment': treatment
        }
        
        # 根据性别选择对应的主病表
        disease_map = MALE_DISEASE_MAP if gender == 'male' else FEMALE_DISEASE_MAP
        
        # 获取主病和行流信息
        disease = disease_map.get(birth_branch, {}).get(illness_stem, "未知")
        flow = FLOW_MAP.get(birth_branch, {}).get(illness_stem, "未知")
        
        # 确定邪气类型
        evil_qi = None
        if '木' in flow:
            evil_qi = '风邪'
        elif '火' in flow:
            evil_qi = '热邪''暑邪''温邪'
        elif '土' in flow:
            evil_qi = '湿邪'
        elif '金' in flow:
            evil_qi = '燥邪'
        elif '水' in flow:
            evil_qi = '寒邪'

        # 获取治疗方案
        treatment = get_treatment_info(evil_qi, disease) if evil_qi else {'加临': '未知', '用方': '未知'}

        # 添加调试信息
        print(f"===== 诊断信息 =====")
        print(f"性别：{'男' if gender == 'male' else '女'}")
        print(f"出生年：{birth_year}年")
        print(f"出生年地支：{birth_branch}")
        print(f"发病日期：{illness_date.strftime('%Y年%m月%d日')}")
        print(f"发病日天干：{illness_stem}")
        print(f"主病：{disease}")
        print(f"行流：{flow}")
        print(f"邪气：{evil_qi}")
        print(f"加临：{treatment['加临']}")
        print(f"用方：{treatment['用方']}")
        print(f"==================")
        
        return {
            'birth_branch': birth_branch,
            'illness_stem': illness_stem,
            'disease': disease,
            'flow': flow,
            'evil_qi': evil_qi,
            'treatment': treatment,
            'ganzhi_info': ganzhi_info  # 添加天干地支信息
        }
    except Exception as e:
        print(f"获取信息时出错: {str(e)}")
        return {
            'birth_branch': "未知",
            'illness_stem': "未知",
            'disease': "未知",
            'flow': "未知",
            'evil_qi': "未知",
            'treatment': {'加临': '未知', '用方': '未知'}
        }

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/recommend', methods=['POST'])
def recommend():
    try:
        data = request.json
        print("收到的数据:", data)
        
        birth_date = datetime.strptime(data['birthDate'], '%Y-%m-%d')
        illness_date = datetime.strptime(data['illnessDate'], '%Y-%m-%d')
        gender = data['gender']
        
        info = get_info(birth_date.year, illness_date, gender)
        
        result = {
            'birth_year': birth_date.year,
            'birth_branch': info['birth_branch'],
            'illness_date': data['illnessDate'],
            'illness_stem': info['illness_stem'],
            'disease': info['disease'],
            'flow': info['flow'],
            'evil_qi': info['evil_qi'],
            'treatment': info['treatment'],
            'prescription_details': get_prescription_details(info['treatment']['用方']),
            'gender': gender,
            'ganzhi_info': info['ganzhi_info']  # 添加天干地支信息
        }
        
        print("返回结果:", result)
        return jsonify(result)
    except Exception as e:
        print("错误：", str(e))
        return jsonify({'error': f'处理请求时出错: {str(e)}'})

if __name__ == '__main__':
    app.run(debug=True)